name: Build Plugin Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build and Attach Release Zip
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Install production dependencies
        run: composer install --no-dev --prefer-dist --no-progress --no-interaction --optimize-autoloader

      - name: Prepare plugin payload
        run: |
          mkdir -p build
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='build' \
            --exclude='var' \
            --exclude='phpstan.neon.dist' \
            --exclude='phpstan-bootstrap.php' \
            --exclude='.gitignore' \
            ./ build/codguard

      - name: Create distribution zip
        run: |
          cd build
          zip -r codguard.zip codguard

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: build/codguard.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

